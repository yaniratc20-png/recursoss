<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte Diario de Horas Extras</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
.container { width: 95%; max-width: 900px; margin: 20px auto; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
h2 { text-align: center; margin-bottom: 25px; font-size: 26px; color: #333; }
.encabezado { border: 2px solid #28a745; padding: 15px; margin-bottom: 20px; border-radius: 10px; background: #f9fff9; }
.trabajador { border: 2px solid #007BFF; padding: 15px; margin-bottom: 20px; border-radius: 10px; position: relative; background: #f9fcff; }
.trabajador h3 { margin-top: 0; }
.trabajador button.remove-btn { position: absolute; top: 10px; right: 10px; background: #dc3545; color: #fff; border: none; border-radius: 6px; padding: 5px 10px; cursor: pointer; }
.trabajador button.remove-btn:hover { background: #c82333; }
label { font-weight: bold; display: block; margin: 8px 0 5px; font-size: 18px; }
input, textarea, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
input[readonly] { background: #eee; }
button.add-btn { display: inline-block; background: #28a745; color: #fff; padding: 12px 20px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 10px; }
button.add-btn:hover { background: #1e7e34; }
button.submit-btn { display: inline-block; background: #007BFF; color: #fff; padding: 12px 20px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 10px; }
button.submit-btn:hover { background: #0056b3; }
.horas-container { display: flex; gap: 10px; }
.horas-container input { flex: 1; }
@media (max-width: 600px) { h2 { font-size: 22px; } label, input, textarea, select, button { font-size: 16px; } .horas-container { flex-direction: column; } }
</style>
</head>
<body>
<div class="container">
<h2>Reporte Diario de Horas Extras</h2>
<form id="reporteForm">
<div class="encabezado">
<label>Fecha del Reporte:</label>
<input type="date" name="fecha_reporte" required>
<label>Jefe Responsable:</label>
<input type="text" name="jefe_responsable" required>
</div>

<div id="trabajadoresContainer"></div>

<button type="button" class="add-btn" onclick="agregarTrabajador()">+ Agregar Trabajador</button>
<br><br>
<button type="submit" class="submit-btn">Enviar Reporte</button>
</form>
</div>

<script>
let contador = 0;
let trabajadoresData = [];
const apiURL = "https://script.google.com/macros/s/AKfycbyOvdQLUtGj5bZf_h75wM8yigoQNJPRd2ALFpiCQ0O8bsJr4ekx9XFhPMqxhbGPTxufAg/exec";

// Cargar trabajadores desde Web App
async function cargarTrabajadores() {
  try {
    const res = await fetch(apiURL);
    trabajadoresData = await res.json();
    console.log("Trabajadores cargados:", trabajadoresData);
    agregarTrabajador(); // agrega primer trabajador
  } catch(err) {
    console.error("Error cargando trabajadores:", err);
    alert("No se pudieron cargar los trabajadores.");
  }
}

// Actualizar selects
function actualizarSelects() {
  document.querySelectorAll("select.trabajador-select").forEach(select => {
    select.innerHTML = '<option value="">Seleccione...</option>';
    trabajadoresData.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.nombre;
      opt.textContent = t.nombre;
      select.appendChild(opt);
    });
  });
}

// Agregar trabajador
function agregarTrabajador() {
  contador++;
  const wrapper = document.getElementById("trabajadoresContainer");
  const div = document.createElement("div");
  div.className = "trabajador";
  div.id = `trabajador_${contador}`;
  div.innerHTML = `
    <h3>Trabajador ${contador}</h3>
    <button type="button" class="remove-btn" onclick="eliminarTrabajador(${contador})">Eliminar</button>
    <label>Nombre del Trabajador:</label>
    <select name="nombre_${contador}" id="nombre_${contador}" class="trabajador-select" required onchange="llenarDNI(${contador})">
      <option value="">Seleccione...</option>
    </select>
    <label>DNI:</label>
    <input type="text" name="dni_${contador}" id="dni_${contador}" readonly>
    <label>Hora de Inicio:</label>
    <input type="time" name="hora_inicio_${contador}" required>
    <label>Hora de Fin:</label>
    <input type="time" name="hora_fin_${contador}" required>
    <label>Horas Extras:</label>
    <div class="horas-container">
      <input type="number" name="horas_${contador}" min="0" placeholder="Horas" required>
      <input type="number" name="minutos_${contador}" min="0" max="59" placeholder="Minutos" required>
    </div>
    <label>Lugar:</label>
    <input type="text" name="lugar_${contador}" required>
    <label>Trabajo Realizado:</label>
    <textarea name="trabajo_realizado_${contador}" rows="3"></textarea>
  `;
  wrapper.appendChild(div);
  actualizarSelects();
}

// Eliminar trabajador
function eliminarTrabajador(id) {
  const div = document.getElementById(`trabajador_${id}`);
  if(div) div.remove();
  reenumerarTrabajadores();
}

// Reenumerar después de eliminar
function reenumerarTrabajadores() {
  const contenedor = document.getElementById("trabajadoresContainer");
  const bloques = contenedor.querySelectorAll(".trabajador");
  contador = 0;
  bloques.forEach((bloque, index) => {
    contador++;
    bloque.id = `trabajador_${contador}`;
    bloque.querySelector("h3").textContent = `Trabajador ${contador}`;
    bloque.querySelector(".remove-btn").setAttribute("onclick", `eliminarTrabajador(${contador})`);
    bloque.querySelector("select.trabajador-select").name = `nombre_${contador}`;
    bloque.querySelector("select.trabajador-select").id = `nombre_${contador}`;
    bloque.querySelector("input[name^='dni_']").name = `dni_${contador}`;
    bloque.querySelector("input[name^='dni_']").id = `dni_${contador}`;
    bloque.querySelector("input[name^='hora_inicio_']").name = `hora_inicio_${contador}`;
    bloque.querySelector("input[name^='hora_fin_']").name = `hora_fin_${contador}`;
    bloque.querySelector("input[name^='horas_']").name = `horas_${contador}`;
    bloque.querySelector("input[name^='minutos_']").name = `minutos_${contador}`;
    bloque.querySelector("input[name^='lugar_']").name = `lugar_${contador}`;
    bloque.querySelector("textarea[name^='trabajo_realizado_']").name = `trabajo_realizado_${contador}`;
  });
}

// Llenar DNI automáticamente
function llenarDNI(i) {
  const nombre = document.getElementById(`nombre_${i}`).value;
  const trabajador = trabajadoresData.find(t => t.nombre === nombre);
  document.getElementById(`dni_${i}`).value = trabajador ? trabajador.dni : "";
}

// Enviar reporte
document.getElementById("reporteForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const fd = new FormData(this);
  const payload = {
    fecha_reporte: fd.get("fecha_reporte"),
    jefe_responsable: fd.get("jefe_responsable"),
    trabajadores: []
  };
  for(let i=1;i<=contador;i++){
    const nombre = fd.get(`nombre_${i}`);
    if(nombre){
      let horas = parseInt(fd.get(`horas_${i}`))||0;
      let minutos = parseInt(fd.get(`minutos_${i}`))||0;
      if(minutos>59) minutos=59;
      payload.trabajadores.push({
        nombre,
        dni: fd.get(`dni_${i}`),
        hora_inicio: fd.get(`hora_inicio_${i}`),
        hora_fin: fd.get(`hora_fin_${i}`),
        horas,
        minutos,
        lugar: fd.get(`lugar_${i}`),
        trabajo_realizado: fd.get(`trabajo_realizado_${i}`)
      });
    }
  }
  try{
    const res = await fetch(apiURL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const resp = await res.json();
    alert(resp.message);
    if(resp.success){
      this.reset();
      document.getElementById("trabajadoresContainer").innerHTML="";
      contador=0;
      agregarTrabajador();
    }
  }catch(err){
    console.error("Error al enviar:", err);
    alert("Error al enviar: " + err);
  }
});

window.onload = cargarTrabajadores;
</script>
</body>
</html>
